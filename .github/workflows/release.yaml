name: Release

on:
  push:
    branches:
      - 'release/**'

jobs:
  auto-version:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: write
    steps:
      - name: checkout repository
        uses: actions/checkout@v4
      - name: setup uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
      - name: update ska-utils version
        working-directory: ./shared/ska_utils
        run: |
          make sync
          uv run hatch version release
      - name: update sk-agents version
        working-directory: ./src/sk-agents
        run: |
          make sync
          uv run hatch version release
      - name: update ao version
        working-directory: ./src/orchestrators/assistant-orchestrator/orchestrator
        run: |
          make sync
          uv run hatch version release
      - name: update ao-services version
        working-directory: ./src/orchestrators/assistant-orchestrator/services
        run: |
          make sync
          uv run hatch version release
      - name: push version updates
        run: |
          git checkout ${{ github.ref_name }}
          git config --global user.name "Teal Agents Bot"
          git config --global user.email " "
          git commit -am "bump version [skip ci]"
          git push --set-upstream origin ${{ github.ref_name }}

  create-pr:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
      pull-requests: write
    steps:
      - name: checkout repository
        uses: actions/checkout@v4
      - name: setup uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true
      - name: create pr
        run: |
          gh pr create --base main --head ${{ github.ref_name }} --title "${{ github.ref_name }}" --body "Create release versions from ${{ github.ref_name }}"
