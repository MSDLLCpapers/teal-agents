
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
      
      
        
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.7.2">
    
    
      
        <title>Phase 1 - State Refactoring of Teal Agents - Agent component - Teal Agents Framework</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.484c7ddc.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.ab4e12ef.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#phase-1-state-refactoring-of-teal-agents-agent-component" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Teal Agents Framework" class="md-header__button md-logo" aria-label="Teal Agents Framework" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Teal Agents Framework
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Phase 1 - State Refactoring of Teal Agents - Agent component
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/MSDLLCpapers/teal-agents" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    teal-agents
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Teal Agents Framework" class="md-nav__button md-logo" aria-label="Teal Agents Framework" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Teal Agents Framework
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/MSDLLCpapers/teal-agents" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.1.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    teal-agents
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Chat Completion Overview
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../reference/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Code Modules Reference
  

    
  </span>
  
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Human-in-the-Loop
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            
  
    Human-in-the-Loop
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../hitl/hitl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Requiring Human Consent
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../hitl/persistence/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Managing Task State
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../hitl/plugin_catalog/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Cataloging Agent Tools
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../hitl/authorization/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Authorizing on Behalf of Users
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../hitl/auth_storage/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Storing Authenthication Credentials
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
          
        
        <input class="md-nav__toggle md-toggle md-toggle--indeterminate" type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    
  
    Demos
  

    
  </span>
  
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            
  
    Demos
  

          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../demos/01_getting_started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Getting Started
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../demos/02_input_output/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Input and Output
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../demos/03_plugins/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Plugins
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../demos/04_remote_plugins/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Remote Plugins
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../demos/06_deployment_github/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Deploying from Github
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../demos/07_task_output/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Task Output
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../demos/08_multi_modal/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Multi-Modal
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../demos/09_chat_simple/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Simple Chatbot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../demos/10_chat_plugins/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Advanced Chatbot
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../demos/11_hitl/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    
  
    Human-in-the-Loop
  

    
  </span>
  
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#objective" class="md-nav__link">
    <span class="md-ellipsis">
      
        Objective
      
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#core-concepts" class="md-nav__link">
    <span class="md-ellipsis">
      
        Core Concepts
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core Concepts">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-session-id-s" class="md-nav__link">
    <span class="md-ellipsis">
      
        1. Session ID (S)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-task-id-t" class="md-nav__link">
    <span class="md-ellipsis">
      
        2. Task ID (T)
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-request-id-r" class="md-nav__link">
    <span class="md-ellipsis">
      
        3. Request ID (R)
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#example-flow" class="md-nav__link">
    <span class="md-ellipsis">
      
        Example Flow
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Example Flow">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#new-request" class="md-nav__link">
    <span class="md-ellipsis">
      
        New Request
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#follow-on-request" class="md-nav__link">
    <span class="md-ellipsis">
      
        Follow-on Request
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-requirements" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Requirements
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Requirements">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#application-integration" class="md-nav__link">
    <span class="md-ellipsis">
      
        Application Integration
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-models" class="md-nav__link">
    <span class="md-ellipsis">
      
        Data Models
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#authentication-and-authorization" class="md-nav__link">
    <span class="md-ellipsis">
      
        Authentication and Authorization
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration-system" class="md-nav__link">
    <span class="md-ellipsis">
      
        Configuration System
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-management" class="md-nav__link">
    <span class="md-ellipsis">
      
        State Management
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#error-handling" class="md-nav__link">
    <span class="md-ellipsis">
      
        Error Handling
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#implementation-details" class="md-nav__link">
    <span class="md-ellipsis">
      
        Implementation Details
      
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Implementation Details">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#api-version-detection-and-routing" class="md-nav__link">
    <span class="md-ellipsis">
      
        API Version Detection and Routing
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#usermessage-input-model" class="md-nav__link">
    <span class="md-ellipsis">
      
        UserMessage Input Model
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-aware-handler-implementation" class="md-nav__link">
    <span class="md-ellipsis">
      
        State-Aware Handler Implementation
      
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#persistence-abstraction" class="md-nav__link">
    <span class="md-ellipsis">
      
        Persistence Abstraction
      
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              
                



  


              
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="phase-1-state-refactoring-of-teal-agents-agent-component">Phase 1 - State Refactoring of Teal Agents - Agent component</h1>
<h2 id="objective">Objective</h2>
<p>The Agent component of Teal Agents was originally designed to be completely
stateless.  Each invocation accepted a list of "Chat History" messages which
were to contain the entirety of the conversation, thus far. While this would be
ideal to maintain, we have reached a point in its evolution where we will have
to pivot and begin maintaining state in order to support more complex use cases
(e.g. HITL and Authorization for tool use). The purpose of this document is to
provide an overview and required context which should be considered while
designing the implementation of state for this Agent component.</p>
<p>When refactoring, the API version which should act as the base pattern for the
new capability should be <code>skagents/v2alpha1</code>. The configuration file structure
should remain the same, but the new API version should be called
<code>tealagents/v1alpha1</code>.</p>
<h2 id="core-concepts">Core Concepts</h2>
<p>To enable stateful agent invocation, we will need to introduce three new
concepts in to the agent invocation flow: Session, Task, and Request.</p>
<h3 id="1-session-id-s">1. Session ID (S)</h3>
<ul>
<li><strong>Purpose</strong>: Represents the highest-level grouping, corresponding to a continuous interaction or "conversation" with a client.</li>
<li><strong>Scope</strong>: It logically groups together multiple related tasks initiated by a user. For example, a user's entire interaction with a chatbot for a specific purpose would be one session.</li>
<li><strong>Relevance</strong>: While not directly used for the internal mechanics of agent/orchestrator state, it provides the essential client-facing context and allows clients to manage and reference logical units of work.</li>
<li><strong>Lifecycle</strong>: Sessions persist across multiple tasks and can span extended periods of user interaction.</li>
</ul>
<h3 id="2-task-id-t">2. Task ID (T)</h3>
<ul>
<li><strong>Purpose</strong>: Represents a single, stateful "job" or goal that the system is asked to accomplish. A task can be simple (a single agent invocation) or complex (an orchestration involving multiple agents and sub-orchestrators).</li>
<li><strong>State</strong>: This is the lynchpin of the stateful architecture. The state associated with a Task ID must include:<ul>
<li><strong>Interaction History</strong>: A "chat history" or log of all invocations and responses related to the task. This is critical for providing context in follow-on invocations.</li>
<li><strong>Execution Trace</strong>: A record of the steps taken, tools used, and intermediate results generated.</li>
<li><strong>Status</strong>: The current state of the task (e.g., <code>Running</code>, <code>Paused</code>, <code>Completed</code>, <code>Failed</code>).</li>
<li><strong>User Identity</strong>: The unique identifier of the user who created the task for authorization purposes.</li>
<li><strong>Timestamps</strong>: Creation time, last updated time, and optional expiration time.</li>
<li><strong>Metadata</strong>: Additional context and configuration data specific to the task.</li>
</ul>
</li>
<li><strong>Lifecycle</strong>: A task is created upon the initial invocation and persists until it is fully completed. Follow-on invocations from the client reference the same Task ID to leverage its history and state.</li>
<li><strong>Concurrency</strong>: Multiple concurrent access attempts to the same task must be handled safely to prevent data corruption.</li>
</ul>
<h3 id="3-request-id-r">3. Request ID (R)</h3>
<ul>
<li><strong>Purpose</strong>: Represents a single, atomic attempt or invocation within a task. It provides the finest level of granularity for tracking and control.</li>
<li><strong>Scope</strong>: A unique Request ID is generated for each invocation of an agent or orchestrator. All actions performed within that invocation, including tool calls, belong to that single Request ID.</li>
<li><strong>Criticality for HITL</strong>: The Request ID is the key to enabling HITL. It allows the system to pause not just a general task, but the <em>specific agent invocation</em> that requires human approval. This prevents ambiguity and allows for precise control. When a <code>Resume Handler</code> approves an action, it targets the specific Request ID.</li>
<li><strong>Benefits</strong>:<ul>
<li><strong>Idempotency</strong>: If a resume signal is received multiple times, the system can check the status of the Request ID and prevent duplicate execution.</li>
<li><strong>Auditing</strong>: Provides a detailed, auditable log of every single action taken by the system.</li>
<li><strong>Traceability</strong>: Links all telemetry and logging data to specific request instances.</li>
</ul>
</li>
</ul>
<h2 id="example-flow">Example Flow</h2>
<h3 id="new-request">New Request</h3>
<ol>
<li>An agent receives a request from either a client or an orchestrator that
   may or may not include a "Session ID" but which DOES NOT contain a "Task ID"</li>
<li>If not provided, the agent generates a new "Session ID"</li>
<li>The agent generates a new "Task ID" and a new "Request ID"</li>
<li>The agent persists the request in its state store with the associated "Task ID"</li>
<li>The agent builds the appropriate chat history and invokes the LLM</li>
<li>The agent receives the response from the LLM and persists this, associated
   with the same "Task ID". For now we'll focus on getting state implemented
   ignore future HITL or authorization requirements.</li>
<li>The agent returns the response along with the "Session ID", "Task ID",
   and "Request ID" to the client or orchestrator</li>
</ol>
<h3 id="follow-on-request">Follow-on Request</h3>
<ol>
<li>An agent receives a follow-on request from either a client or an orchestrator
   that includes a "Task ID".</li>
<li>The agent generates a new "Request ID"</li>
<li>The agent verifies that the requesting identity (user) was the same
   as the one who initiated the task in the first place (if not, 401).</li>
<li>The agent retrieves all associated messages with the provided "Task ID",
   builds the chat history (including the newly received message), and invokes
   the LLM."</li>
<li>The agent receives the response from the LLM and persists this, associated
   with the same "Task ID".</li>
<li>The agent returns the response along with the "Session ID", "Task ID",
   and "Request ID" to the client or orchestrator</li>
</ol>
<h2 id="implementation-requirements">Implementation Requirements</h2>
<h3 id="application-integration">Application Integration</h3>
<ul>
<li>The new <code>tealagents/v1alpha1</code> API version should follow the same pattern as existing versions:</li>
<li>Create an <code>AppV3</code> class similar to <code>AppV1</code> and <code>AppV2</code></li>
<li>Attempt to reuse the existing <code>routes.py</code> <code>get_rest_routes</code> function if possible by passing appropriate configuration values</li>
<li>If reuse is not feasible due to authentication requirements and scope of changes, create new route handling logic that maintains existing capabilities (especially telemetry)</li>
<li>Exclude websocket routes (<code>get_websocket_routes</code>) from the new version as they are deprecated</li>
<li>The main <code>app.py</code> should detect the new API version and route to <code>AppV3</code> accordingly</li>
<li>Complete isolation from existing API versions to maintain 100% backward compatibility</li>
</ul>
<h3 id="data-models">Data Models</h3>
<ul>
<li>Define a new input type called <code>UserMessage</code> which:</li>
<li>Does NOT inherit from <code>BaseMultiModalInput</code> but has a similar structure</li>
<li>Contains a list of <code>MultiModalItem</code> objects for the current message (text, images, etc.)</li>
<li>Removes the <code>chat_history</code> field since history is now managed server-side</li>
<li>Optionally accepts "Session ID" and "Task ID" parameters</li>
<li>Includes proper validation for UUID formats and required fields</li>
<li>Should look like: <code>{ session_id?, task_id?, items: MultiModalItem[] }</code></li>
<li>Implement comprehensive response models that include all state identifiers</li>
<li>Define state data models for Session, Task, and Request entities with proper relationships and constraints</li>
</ul>
<h3 id="authentication-and-authorization">Authentication and Authorization</h3>
<ul>
<li>Implement a robust authentication system using Entra ID app registration:</li>
<li>Clients must send authorization tokens with appropriate scopes to access the platform</li>
<li>Implement middleware or route-level logic to verify tokens and extract unique user identifiers (OID)</li>
<li>Store user identity with persistent tasks for ownership verification</li>
<li>Verify user identity on follow-on requests (return 401 if user doesn't match task owner)</li>
<li>For initial implementation, abstract this logic and provide mock implementations</li>
<li>This authentication requirement may preclude reusing the existing <code>routes.py</code> file</li>
<li>Plan follow-up tasks for actual Entra ID integration and token validation</li>
</ul>
<h3 id="configuration-system">Configuration System</h3>
<ul>
<li>The new API version is indicated by <code>apiVersion: tealagents/v1alpha1</code> in the configuration file</li>
<li>Configuration file structure remains the same as existing versions (see <code>demos/ZZ_wikipedia_demo/config.yaml</code>)</li>
</ul>
<h3 id="state-management">State Management</h3>
<ul>
<li>Abstract out the persistence management to support multiple providers</li>
<li>Implement an in-memory persistence provider for initial testing (no need for actual persistent implementation initially)</li>
<li>Design for future Redis or DynamoDB implementations</li>
<li>Include "last updated" timestamps for future cleanup capabilities</li>
<li>Do not implement automatic cleanup initially - preserve all task data</li>
<li>Handle concurrent access to the same task safely to prevent data corruption</li>
<li>State should include sufficient information to rebuild chat history and context</li>
</ul>
<h3 id="error-handling">Error Handling</h3>
<ul>
<li>Persistence failures should result in 5xx response codes</li>
<li>Corrupted or inconsistent state data should cause invocation failures with 5xx responses</li>
<li>Implement appropriate timeout handling for long-running operations</li>
<li>Consider implementing keepalive mechanisms for SSE streams (similar to previous 30-second dummy events for long LLM calls)</li>
<li>Provide comprehensive error messages for debugging and troubleshooting</li>
</ul>
<h2 id="implementation-details">Implementation Details</h2>
<h3 id="api-version-detection-and-routing">API Version Detection and Routing</h3>
<ul>
<li>Define a new logic path for API version <code>tealagents/v1alpha1</code> following the same pattern as earlier API versions</li>
<li>The main <code>app.py</code> should detect the new <code>tealagents/v1alpha1</code> API version and route to the appropriate <code>AppV3</code> class</li>
<li>Complete isolation ensures this new capability doesn't affect existing functionality</li>
</ul>
<h3 id="usermessage-input-model">UserMessage Input Model</h3>
<ul>
<li>Create a new <code>UserMessage</code> class that looks similar to <code>BaseMultiModalInput</code> but simplified for single-message input</li>
<li>Structure: Contains a list of <code>MultiModalItem</code> objects (content_type and content) for the current message</li>
<li>Optional parameters: "Session ID" and "Task ID" for state management</li>
<li>Validation: Proper UUID format validation and required field checks</li>
</ul>
<h3 id="state-aware-handler-implementation">State-Aware Handler Implementation</h3>
<ul>
<li>Implement a new handler for the new API version that performs state management tasks:</li>
<li>Save new state for initial requests</li>
<li>Load existing state for follow-on requests</li>
<li>Save responses and update state after processing</li>
<li>Handle authentication and user identity verification</li>
</ul>
<h3 id="persistence-abstraction">Persistence Abstraction</h3>
<ul>
<li>Abstract out the persistence management to support multiple persistence providers</li>
<li>Implement an in-memory persistence provider for testing and initial development</li>
<li>Design interfaces to support future Redis or DynamoDB implementations</li>
</ul>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      
      <script id="__config" type="application/json">{"annotate": null, "base": "../../..", "features": ["content.code.copy", "content.code.select", "navigation.path", "navigation.sections", "navigation.expand", "content.code.annotate"], "search": "../../../assets/javascripts/workers/search.2c215733.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.79ae519e.min.js"></script>
      
    
  </body>
</html>